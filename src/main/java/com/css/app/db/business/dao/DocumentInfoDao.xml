<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.css.app.db.business.dao.DocumentInfoDao">

	<select id="queryObject" resultType="com.css.app.db.business.entity.DocumentInfo">
		select * from DB_DOCUMENT_INFO where ID = #{value}
	</select>

	<select id="queryList" resultType="com.css.app.db.business.entity.DocumentInfo">
		select t.*,c.under_depts,d.* from DB_DOCUMENT_INFO t
			left join (select INFO_ID,USER_NAME as leader_name ,LEADER_COMMENT as leader_content,CREATED_TIME as leader_time,row_number() over(partition by info_id order by created_time asc) as dNum from DB_DOCUMENT_SZPS) d on t.id = d.info_id
			left join (select distinct info_id,listagg(sub_dept_name || nvl2(undertaker_name,'/' || undertaker_name,null), ',') within group(order by created_time desc) over(partition by info_id) under_depts from DB_SUB_DOC_INFO) c on t.id = c.info_id	
		<if test="orgid != null and orgid != ''" >
			left join DB_SUB_DOC_INFO  dadi on t.id=dadi.INFO_ID
		</if>
		 where (d.dNum = 1 or d.dNum is null) 
		 <if test="orgid != null and orgid != '' ">
			and dadi.SUB_DEPT_ID=#{orgid}
		</if>
		<if test='docStatus == "1"'>
			and t.STATUS=0
		</if>
		<if test='docStatus == "2"'>
			and t.STATUS &gt; 0
		</if>
		<if test="hasUpdate != null"> 
			and t.LATEST_REPLY !='' and t.LATEST_REPLY is not null and t.id not in(select INFO_ID from DB_DOCUMENT_READ where USER_ID=#{loginUserId})
		</if>
		<if test="search != null and search != ''">
			and (t.DOC_TITLE like '%'||#{search}||'%' or t.BANJIAN_NUMBER  like '%'||#{search}||'%')
		</if>
		<if test="year != null">
			and to_char(t.FIRST_ZB_TIME) like '%'||#{year}||'%'
		</if>
		<if test="state != null and state != ''">
			and t.STATUS=#{state}
		</if>
		<if test="type != null">
			and t.DOC_TYPE_ID=#{type}
		</if>
		
		<if test="latestreply != null and latestreply != ''">
				and t.LATEST_REPLY !=''  
			</if>
		<if test="isnotuserid != null">
			and (t.sz_read_ids not like '%'||#{isnotuserid}||'%' or t.sz_read_ids is null)
		</if>
		<choose>
			<when test="sort == 'desc'">order by t.BANJIAN_NUMBER desc</when>
			<when test="sort == 'asc'"> order by t.BANJIAN_NUMBER ASC</when>
			<otherwise>order by t.STATUS asc,t.CREATED_TIME desc</otherwise>
		</choose>
		
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
	<select id="queryPersonList" resultType="com.css.app.db.business.entity.DocumentInfo">
		WITH V_RESULT as(select SUB_ID from 
		(select SUB_ID, row_number() over(partition by SUB_ID order by CREATED_TIME desc) as num
		from DB_SUB_DOC_TRACKING where 1=1 
		<if test="deptId !=null and deptId !=''">
			and REC_DEPT_ID = #{deptId}
		</if>
		<if test="loginUserId !=null and loginUserId !=''">
			and RECEIVER_ID = #{loginUserId}
		</if>)
		where num =1)
			
		select t.*,c.under_depts,d.* from DB_DOCUMENT_INFO t
		left join DB_SUB_DOC_INFO  dadi on t.id=dadi.INFO_ID inner join V_RESULT a on dadi.id= a.sub_id
		left join (select INFO_ID,USER_NAME as leader_name ,LEADER_COMMENT as leader_content,CREATED_TIME as leader_time,row_number() over(partition by info_id order by created_time asc) as dNum from DB_DOCUMENT_SZPS) d on t.id = d.info_id
		left join (select distinct info_id,listagg(sub_dept_name || nvl2(undertaker_name,'/' || undertaker_name,null), ',') within group(order by created_time desc) over(partition by info_id) under_depts from DB_SUB_DOC_INFO) c on t.id = c.info_id
		where (d.dNum = 1 or d.dNum is null) 
		<if test='docStatus == "1"'>
			and t.STATUS=0
		</if>
		<if test='docStatus == "2"'>
			and t.STATUS &gt; 0
		</if>
		<if test="hasUpdate != null"> 
			and t.LATEST_REPLY !='' and t.LATEST_REPLY is not null and t.id not in(select INFO_ID from DB_DOCUMENT_READ where USER_ID=#{loginUserId})
		</if>
		<if test="search != null and search != ''">
			and (t.DOC_TITLE like '%'||#{search}||'%' or t.BANJIAN_NUMBER  like '%'||#{search}||'%')
		</if>
		<if test="year != null">
			and to_char(t.FIRST_ZB_TIME) like '%'||#{year}||'%'
		</if>
		<if test="state != null and state != ''">
			and t.STATUS=#{state}
		</if>
		<if test="type != null">
			and t.DOC_TYPE_ID=#{type}
		</if>
		<if test="isnotuserid != null">
			and (t.sz_read_ids not like '%'||#{isnotuserid}||'%' or t.sz_read_ids is null)
		</if>
		order by t.STATUS asc,t.FIRST_ZB_TIME,t.CREATED_TIME desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	<select id="queryDicByType" resultType="com.css.app.db.config.entity.DocumentDic">
		WITH V_RESULT as(select SUB_ID from 
		(select SUB_ID, row_number() over(partition by SUB_ID order by CREATED_TIME desc) as num
		from DB_SUB_DOC_TRACKING where 1=1 
		<if test="deptId !=null and deptId !=''">
			and REC_DEPT_ID = #{deptId}
		</if>
		<if test="loginUserId !=null and loginUserId !=''">
			and RECEIVER_ID = #{loginUserId}
		</if>
	)
	where num =1)
	select dic.*,nvl(s.num,0) hasUpdateNum from DB_DOCUMENT_DIC dic	
	left join(select DOC_TYPE_ID, count(1) as num
	from DB_SUB_DOC_INFO a inner join v_result b on a.ID = b.SUB_ID
	left join "DB_DOCUMENT_INFO" t on a.INFO_ID=t.ID
	where t.LATEST_REPLY !=''
	and t.LATEST_REPLY is not null
	<if test="orgId != null and orgId != '' ">
		and a.SUB_DEPT_ID=#{orgId}
	</if>
	and t.id not in ( select INFO_ID from DB_DOCUMENT_READ where USER_ID=#{userId}) group by t.DOC_TYPE_ID )s	
	on dic.value = s.DOC_TYPE_ID
	where dic.DIC_TYPE = #{docType} order by value asc
	</select>
	<!--根据年度获取每个状态的数量   CREATED_TIME暂为年度时间-->
	<select id="queryListByYear" resultType="map">
	select sum(blz+bj+ctls) as total,sum(blz) as blz,sum(bj) as bj,sum(ctls) as ctls from (
		select 
         (case when ddi.STATUS='1' then count(ddi.STATUS) else 0 end ) as blz,
	        (case when ddi.STATUS='2' then count(ddi.STATUS) else 0 end ) as bj,
	        (case when ddi.STATUS='3' then count(ddi.STATUS) else 0 end ) as ctls       
        from DB_DOCUMENT_INFO  ddi
		where 1=1 and FIRST_ZB_TIME is not null
		<if test="year != null">
			and to_char(ddi.FIRST_ZB_TIME) like '%'||#{year}||'%'
		</if>
		
		
		group by ddi.STATUS
		order by ddi.STATUS asc
		)
	</select>
		<!--根据年度获取每个状态的数量   CREATED_TIME暂为年度时间-->
	<select id="queryListByOrgYear" resultType="map">
	select org.ID,org.NAME as dwname,
		isnull(shu.blz,0) as blz,
        isnull(shu.bj,0)  as bj,
        isnull(shu.ctls,0) as ctls
		 from BASE_APP_ORGAN org
		left join
	
	(
		select d.SUB_DEPT_ID as id,d.SUB_DEPT_NAME as dwname,sum(blz) as blz,sum(bj) as bj,sum(ctls) as ctls from (
			select dadi.SUB_DEPT_ID ,dadi.SUB_DEPT_NAME ,
	        (case when ddi.STATUS='1' then count(ddi.STATUS) else 0 end ) as blz,
	        (case when ddi.STATUS='2' then count(ddi.STATUS) else 0 end ) as bj,
	        (case when ddi.STATUS='3' then count(ddi.STATUS) else 0 end ) as ctls
	        
	        from DB_DOCUMENT_INFO  ddi
			left join (select SUB_DEPT_ID,SUB_DEPT_NAME,INFO_ID,CREATED_TIME,DOC_STATUS
	                          from DB_SUB_DOC_INFO)  dadi
			on ddi.id=dadi.INFO_ID
			where 1=1 and ddi.FIRST_ZB_TIME is not null
			<if test="year != null">
				and to_char(dadi.CREATED_TIME) like '%'||#{year}||'%'
			</if>
			group by ddi.STATUS,dadi.SUB_DEPT_ID,dadi.SUB_DEPT_NAME
			order by ddi.STATUS asc
			)d  GROUP by d.SUB_DEPT_ID,d.SUB_DEPT_NAME
	)shu on org.id=shu.id where org.PARENT_ID='root'
	</select>
	
	<select id="queryListByDicType" resultType="map">
	select dic.TEXT as name,dic.value as type,ifnull(shu.num,0) as num
		 from DB_DOCUMENT_DIC dic
		left join
	
	(
			select DOC_TYPE_ID,count(DOC_TYPE_ID) as num
	        from DB_DOCUMENT_INFO  
			where 1=1 and FIRST_ZB_TIME is not null
			<if test="search != null and search != ''">
				and (DOC_TITLE like '%'||#{search}||'%' or BANJIAN_NUMBER  like '%'||#{search}||'%')
			</if>
			<if test="status != null and status != ''">
				and STATUS=#{status}
			</if>
			<if test="status2 != null and status2 != ''">
				and STATUS > #{status2}
			</if>
			<if test="latestreply != null and latestreply != ''">
				and LATEST_REPLY !=''  
			</if>
			<if test="isnotuserid != null">
			and (sz_read_ids not like '%'||#{isnotuserid}||'%' or sz_read_ids is null)
			</if>
			GROUP by DOC_TYPE_ID
	)shu on dic.value=shu.DOC_TYPE_ID where dic.DIC_TYPE='document_type' 
	<if test="type != null and type != ''">
				and dic.VALUE=#{type}
			</if>
	order by dic.SORT asc
	</select>
	
	
	
	<select id="queryListByDicStu" resultType="map">
	select  dic.TEXT as name,
        isnull(sum(shu.bj +shu.ctls), 0)          as bj  ,
        isnull(sum(shu.blz+shu.bj+shu.ctls), 0) as total
		 from DB_DOCUMENT_DIC dic
		left join
	
	(
			select ddi.DOC_TYPE_ID,
	        (case when ddi.STATUS='1' then count(ddi.STATUS) else 0 end ) as blz,
	        (case when ddi.STATUS='2' then count(ddi.STATUS) else 0 end ) as bj,
	        (case when ddi.STATUS='3' then count(ddi.STATUS) else 0 end ) as ctls
	        
	        from DB_DOCUMENT_INFO  ddi where  ddi.FIRST_ZB_TIME is not null
	        <if test="search != null and search != ''">
			and (ddi.DOC_TITLE like '%'||#{search}||'%' or ddi.BANJIAN_NUMBER  like '%'||#{search}||'%')
			</if>
			group by ddi.DOC_TYPE_ID,ddi.STATUS
			
	)shu on dic.value=shu.DOC_TYPE_ID where dic.DIC_TYPE='document_type' group by dic.DIC_TYPE,dic.text  
	</select>
	
	<select id="queryListByDicStutas" resultType="map">
	select ddi.DOC_TYPE_ID,
	        (case when ddi.STATUS='1' then count(ddi.STATUS) else 0 end ) as blz,
	        (case when ddi.STATUS='2' then count(ddi.STATUS) else 0 end ) as bj,
	        (case when ddi.STATUS='3' then count(ddi.STATUS) else 0 end ) as ctls
	         
	        
	        from ZF_MINISTRY_APP_DB.DB_DOCUMENT_INFO  ddi where  ddi.FIRST_ZB_TIME is not null
	        and ddi.DOC_TYPE_ID=#{type}
			group by ddi.DOC_TYPE_ID,ddi.STATUS 
	</select>
	
	
	
 	<select id="queryTotal" resultType="int">
		select count(*) from DB_DOCUMENT_INFO 
	</select>
	 
	<insert id="save" parameterType="com.css.app.db.business.entity.DocumentInfo">
		insert into DB_DOCUMENT_INFO
		(
			"ID", 
			"DOC_TITLE", 
			"SECURITY_ID", 
			"SECURITY_CLASSIFICATION", 
			"URGENCY_ID", 
			"URGENCY_DEGREE", 
			"DOC_CODE", 
			"BANJIAN_NUMBER", 
			"USER_ID", 
			"USER_NAME", 
			"APPLY_TIME", 
			"PRINT_DATE", 
			"JOB_CONTENT", 
			"FIRST_ZB_TIME", 
			"SZ_READ_IDS", 
			"CUIBAN_FLAG", 
			"DOC_TYPE_ID", 
			"DOC_TYPE_NAME",
			"CREATED_TIME", 
			"REMARK",
			"STATUS",
			"FINISH_TIME",
			"LATEST_REPLY",
			"LATEST_SUB_DEPT",
			"LATEST_UNDERTAKER",
			"LATEST_REPLY_TIME"
		)
		values
		(
			#{id}, 
			#{docTitle}, 
			#{securityId}, 
			#{securityClassification}, 
			#{urgencyId}, 
			#{urgencyDegree}, 
			#{docCode}, 
			#{banjianNumber}, 
			#{userId}, 
			#{userName}, 
			#{applyTime}, 
			#{printDate}, 
			#{jobContent}, 
			#{firstZbTime}, 
			#{szReadIds}, 
			#{cuibanFlag}, 
			#{docTypeId}, 
			#{docTypeName},
			#{createdTime},
			#{remark},
			#{status},
			#{finishTime},
			#{latestReply},
			#{latestSubDept},
			#{latestUndertaker},
			#{latestReplyTime}
		)
	</insert>
	 
	<update id="update" parameterType="com.css.app.db.business.entity.DocumentInfo">
		update DB_DOCUMENT_INFO 
		<set>
			<if test="docTitle != null">"DOC_TITLE" = #{docTitle}, </if>
			<if test="securityId != null">"SECURITY_ID" = #{securityId}, </if>
			<if test="securityClassification != null">"SECURITY_CLASSIFICATION" = #{securityClassification}, </if>
			<if test="urgencyId != null">"URGENCY_ID" = #{urgencyId}, </if>
			<if test="urgencyDegree != null">"URGENCY_DEGREE" = #{urgencyDegree}, </if>
			<if test="docCode != null">"DOC_CODE" = #{docCode}, </if>
			<if test="banjianNumber != null">"BANJIAN_NUMBER" = #{banjianNumber}, </if>
			<if test="userId != null">"USER_ID" = #{userId}, </if>
			<if test="userName != null">"USER_NAME" = #{userName}, </if>
			<if test="applyTime != null">"APPLY_TIME" = #{applyTime}, </if>
			<if test="printDate != null">"PRINT_DATE" = #{printDate}, </if>
			<if test="jobContent != null">"JOB_CONTENT" = #{jobContent}, </if>
			<if test="firstZbTime != null">"FIRST_ZB_TIME" = #{firstZbTime}, </if>
			<if test="szReadIds != null">"SZ_READ_IDS" = #{szReadIds}, </if>
			<if test="cuibanFlag != null">"CUIBAN_FLAG" = #{cuibanFlag}, </if>
			<if test="docTypeId != null">"DOC_TYPE_ID" = #{docTypeId}, </if>
			<if test="docTypeName != null">"DOC_TYPE_NAME" = #{docTypeName}, </if>
			<if test="createdTime != null">"CREATED_TIME" = #{createdTime}, </if>
			<if test="remark != null">"REMARK" = #{remark},</if>
			<if test="status != null">"STATUS" = #{status},</if>
			<if test="finishTime != null">"FINISH_TIME" = #{finishTime}</if>
			<if test="latestReply != null">"LATEST_REPLY" = #{latestReply},</if>
			<if test="latestSubDept != null">"LATEST_SUB_DEPT" = #{latestSubDept},</if>
			<if test="latestUndertaker != null">"LATEST_UNDERTAKER" = #{latestUndertaker},</if>
			<if test="latestReplyTime != null">"LATEST_REPLY_TIME" = #{latestReplyTime}</if>
		</set>
		where ID = #{id}
	</update>
	
	<delete id="delete">
		delete from DB_DOCUMENT_INFO where ID = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from DB_DOCUMENT_INFO where ID in 
		<foreach item="id" collection="array" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>

</mapper>